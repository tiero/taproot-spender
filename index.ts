import { bip341, address, networks, CreatorInput, CreatorOutput, Creator, script, Updater, Transaction, Finalizer, Pset, TapLeafScript, witnessStackToScriptWitness, Extractor } from 'liquidjs-lib';
import secp256k1 from '@vulpemventures/secp256k1-zkp';
import fetch from 'node-fetch';

const { BIP341Factory } = bip341;
const { OPS } = script;

const internalPubkey = Buffer.from('021dae61a4a8f841952be3a511502d4f56e889ffa0685aa0098773ea2d4309f624', 'hex');

const scriptHex = '52796b53796b54796b6b6b6b748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea868748c92636c76519976766b9394647c687ea8686c756c6c766ba87b7c7e2012daa779c128ffd161ecdbdf233cad20bca1ee79df09819fbbbb412240679047c26c6c6c6c537a7c528b7ea886a887916900d14f88016aa88800cf750850c30000000000008851';

const prevoutTxID = '5c56948fa3e17a835672db8f25c8dc58480fc1890dba24362cacabcd5b5c8bb9';
const prevoutIndex = 1;



(async () => {
  // get prevout 

  const res = await fetch(`https://blockstream.info/liquidtestnet/api/tx/${prevoutTxID}/hex`);
  const prevoutTxHex = await res.text();
  const prevoutTx = Transaction.fromHex(prevoutTxHex);
  //const prevoutTx = Transaction.fromHex('02000000010182f7db9f78c5f3e200b492c95e10d182a6941839eb0c4afe709698a5a1aa5b4d0000000000fdffffff030ab9ba7f6dc963a45cca3b3bb198579b43c94741670c73af520ea33b44aedf2840089e3926d6bfeb95501c848eb7355f2a9a05b73b61cb682c12c5a1ef8ac3f6665902a0fbae1138f0647a20eb29a8c0fc4e3f54ab06b30bee4a610b53a68a03faa0bd160014c53e19ea1597ec03670aa7cb6ebdeaa7ec91734f01499a818545f6bae39fc03b637f2a4e1e64e590cac1bc3a6f6d71aa4443654c140100000000000186a0002251200eecf207aac8aba6b216ff635f1adeea560fd149eb2c10ef297a0262323a561b01499a818545f6bae39fc03b637f2a4e1e64e590cac1bc3a6f6d71aa4443654c1401000000000000008a00004bd70f0000000247304402202ca22da438622ab1b5d1bec2e7cbf9952e468e3f47f6a04d33e2b93f2354c48502203382609df49fc22e857247cdbf2e9f02c7281b8d197501a69c7123dac3a776cb01210319e8d834fe07ccb8aa310c52293baadf2a6ce715c8d3962697654ff9b75a85f500430100013e493139670d5576227c6657531bcec1a7aa9862413661cbdd362a4b0bfeb6c9139766e745e8b718ed7166cfca20ccf488a3c5a37ea049d25e66e93f73c8832dfd4e10603300000000000000016251ca01de020f116f6e0b16fc73ca243c817775a9c893649dcd7522270ccd2395f41a5667aaf0e17b3db27b9514e4b9509840a4b244f129978965f07550ee8f4bc4cc0e429aeca109c108dac0b7fcd3c9fce1254a275024fb15fa5ccfea35705ae534095b042f75745c59961ab6904c767343d48c6ce00f0861307b5f0dc0b98ad0fd0a234c2d6d746c1d4b31eee8b130e345ac9d13ba89d4987fc6288d3649fc563e5548e6e094ce0160a70c29fb515ff807acaf8139e02c9a60a0257edc2b313258bf19e2dd219fe55c3daae6fb94a429b7914e1372787f0568a819a713fd2ad83e78613e09b79fb4eed43a177d4db8ac14cf31b99f7dc421901d4ca2dc5e33feeed6e8a4ee7bed7328edcae800f812c53867a16d2dc98b0133a8cb28768f52d7b1d7aba5a0b097d319ea088891186d6d8075a9309f488c44b323090937f2029cf68c925f36a0ec5f00a5459d19a777ec7d76d773754009c4d67fca9ffb82d84e3653a38907bbf566a4339dc66866dfff58083738c3ded4c38c9e29bfd4da2fa0a64f4b5414f69f44bac56e9fb043447e476d978c7c2e03a82604d32d3886e008fbc067150ded6f18649c8f22cd7f817c2db47b70558434a37314ab90c8d1048fa57ed8c02de6519e1b58cf557ba805767ce3cf63b238e8072f09063f5cc51c3828dae5ad8bf6094e01e63407c43e2fce33c238e05633e75b6fa8518f43e23fddabd673e5e0992b3dbfae334c1640fa53d89fbf2be96d67e2014c85b935f27a8bcc8402b2d2421c39b6c8c311142aaf3d6977fdf96237f53212382f1665dec2ff292094d0a03ddb1d50fcc41098cbffb30579c4e8e95a884c4c2ac563b56e8fdf9602a36225d0f738843c46050a0be43bc22ca8662412b2e5440f53b054826c116e35538d11f7de363390a09adf87a127013951b9f7e391bed505376fd8e5a5f26ad9cb56309061e5ffb8fb2267497c6a4781524d3ca3152caf8752e03983fb1775b44a1a0a27527327cf15d1763b43dfaf0bce0f44d388665641d2404f139abe2431aa5293804b1434b173f3178bfdf11ac537bddecc1ed103762f7d3225cbba2ed2bf53245810d47c0313838788048143dca2d27b49ebf960a7dbde2f67f1aa80fbbc1a0f491a1e435fe072b7e69d1820fa4b11f6ad72170de8d8e57702c1202f921341228f20ae41fb378f01372ee890f6fbf9d9a1e231e113faddb97445c874c741c51a256f71c7a601b484a767cce02eb89149e360ee61531514d3293302f1bc02c9074027b325b7d799ff63fe0b2d846320bc464d562f29766de7bf974323dc2113b33d69cb21d2eb798e5b87be2440a2723c6c3e8d188dd63aab9f4eb296ff38d75c406ffc19ca30cc49a441098b49fdfb125cdcc88d0c0e10445d2ebdd7a3ac667e2923c27ba93f41d7c69f0df85756b4da1d9269594861aa033fd8a4699b15d6e11b81f987678d500108a3f5405d7be9abb24b11e5d0dad8952434c227a41f3d7def679321a9679464849f8fbb645b5167f0ab72ee5d8e17d8b8d7601dbaf02dabbd7e70da20aec4906b3beeaa888c7ed665702a6491fa4bfa178f47c0970fa6c67d09e732dda81e66ca9e54bbea2d7e3d260187e997b821bbba35651086637d66e88c3d159c60cba18400c6d9c65f7e243e382c01fe68d0716383088cbccfa11dc2298570266c7f30a7209d3051ae1f546fe06851d27ca71354788f26c863b2cb9e7abea790f372730c10f1f4771fba4d733747e6763602ac5f25c4d49bfea3a0699e34fa418e06ceaca8744c4f9b4722633d050fc371e6badd7d6dabff6b9fd84b8d719d5bec9ee204c40705ea5d35ddc64512c32af4131e496589473700e9a0887831aef53977d94a626ca8427b5b1b52dd1ee5b0b485022b860b6178755ac45e42e7533fbebcb6d3ed82ffc7b1c90df9aa7d6011867d4637a9c365347b18ad5e182ec92c4d73b1bdb9aa965cd3d3cd2550b3fa79a0808a1b4e164342876a35b628ffcb99a1312cfe0ec16f085e4eb4800b41a252e97665a06f76e23a4cf454f92d86f76705b5b9b407bdfa0e2fcaa0a32b99c0c59277362219a9fed8a4ca836ccb8eafa9578de6524fad929c7196f7aa92a60990aa2559f881a37674079a2b3e80fdba1a3c1b8765b9d0d273bdb621438fb58ec9906ca2740b44327f005acceb03e206b9b7e2b5ede9002622442118af79776d5cdf81f834f578710c2733cbfc2c51ee9ffb76fca23887f2b270827592455a4b11128ca3bb1843c10134e18aa03be1a31cbf1030f8796828831e020043f94929f15f33ca9f72cc0ed579288aab795413beb28ec0be11d0c3be3680d4ae8dc28ed4fe6634f4ec986d4ac047dedb9668e784afbd06e2b3d2ea0df26e2ed0f2aa9e353ef36d05d5c2965f885e28ba6682325f3a851fd40541c8b6fface85d51e060af355da9abeff4f5011ae89d6bf3db585272a6d9120d0b912c85c29092253c36064f9f9451e430aee472e28bb4186ffc225c406cc998635d9bc5a46a4c23fb900ef85fba969c3e18bde9b7fbb5a7fe6b9a106b3fff9706777e24f8f2a978cd6235dec7496c9b624ad4ff76456b66164e2b0586ea0ed32952bc020fa2d6c719d7e4c59943e296924119f3e035bf676506af6b781cefebe429b96bb4db5db452ed303034be695fe17770855e7e4c0a166a6f0ae967269177dfc496bb34d600db55c1f3219e2c41a252a0e5f8e42189b8e9dd38e3997a47859a8196c716ab2d200f3298e5f031c29de06e4374200c5bd1c39df5f41af2e5748eaae8f2b5a6934fb7d08ccdd51283676388d37c533255a0b0dc56bff3909043bddb42a794b717f6f6d441db14ac2edce965033dcb6df68d42cad6315b4d286de75f5da24130d3b518bd78a097684f20604c61c140949d2771601705872187df0051c8e8b9477bc08fd2f05a520b965cfb685767709124085a9ecd4a0a310a71b7462410369762bff3ec523ddc6a44d6d4d123ef4da1194aba9570527ffb3ac76e1eeee0f193b80be11165aa5a3edab19e240030b329a2dd03fec33f738c04511dcc4842238ee948d58bcc86abbad713eeb1ede663d9b949902aa1197ff67026392e7f18b28f9df872dfe03d9160401f5a2876d3816b168cdb385f850d7f08ca829a1f075c0aa718245a1f04e61fcac55f3e1a2e279f5fc8b1e7aa4058bf03509911486b19fd15cbdc461d179700f9bb2ace519bd45b5a276c82dc5a1bffa453600082192bb43a23f37eb7a81dc94158d778befa5c10976f64bcffe57ddcef40777b645b03c536e3455b32cc066ece7cb14153024ecd935684909353a588e75d4b7425742b2474aeba0863fd5a7c42798a9cfd9cf8da9f95fec51fd51c6d0a6f53c689c7be1451fd83a2f1e6947bdfa9d731cd077cd76222520189a287c5cf2e7fa1873a5b74033e350c3ce9204f9999eaa57e0d369e14e95568f5dc4e793cc3080d8a5e78141a0d526ad584720d13818e4e4890b19321f7d056273d1dfa1506e4935aa8de5ecaae2861d17ab3962f2700a2259c9b59baadfdf0e9ad2d7603a413862d6e252fbf6449953024992cefc578e9144c0ba904f6f4bb796351d878a37056cceb45eae8f848f9d1fc3714c4ca9e467bd99e31e72aec13b19251fed48ba362a9c53b177777a6e477a735a0a9675ecd7ee9b20fed9cfc3f49c3f1dfb951b02b6cedba8bde314e32176741300e1c9211969c13111fac2540a507ccc0eb77f6f1e577297c32e090b2399a8ea48476533bf1849403bba3793a141807c692b627fc62fa7b9fe9d993c01c5ceec4d04f8fc25509ef27ca49d044d618dbcda868355e46257eb1593ab9b72262bfcbc35ede87657c145342848b0fdea8acaa39d9ffd0d16be51e16c7ede04710b95f8780d5444b8bc27cdc4f816382134532697da5f4634a92364dfd9526be1180b283f8720b8f31038ebf809235a6933fc2f72c5c03959b8ec113ae1f200c07edc766a942e46f25ec682cb33c8314abe8dc0496b8e64081327d88492e9bf28dadd0f90a270377e84ca47703adcf8ac32c8c498ac844e583dc9be94a87d67bfddc15f3cac2bb87a871bd789a01cacd8489fbd241cd7b8e366f04377d635e32bdcdc8d6af79ade4569ccd1b076dfae88ef440b7b5605baad23833052e248393d4476cc828aaa89f88f2db46387532b01d17b57c8b549a13922ddde457ab301aac211b422a7fb01cd0489e3d0fd1bf7585613dec471d126ab5d8a02e1faef9db7fc94aceb132d5a523f3bd909cb609501986e369d496ad06d5189e266c9fcd19ed7e1c8a14a87dd80d1956a43257d7077a2db8901d495a86655ce7af5293ec0b475606aa1c9e3a05e2358a0ccd8e0494d4f33bb99b9cf4953200d36164b756657134d8171126fc926ee42ed6abb574377a23214ad8d4b25eead69d02ed96b808c1eda788d11f2d6326dec416e2b5d5004ead376bd137df829573b483a18f426c3f82603dc7bcd8e1d8f3dcdf196661ae833321e9b73e086db84d5375eac6d584104b787f1641d0fe95c4310f994b5815eef232cc292ff19bfeee0dbfaf7f0a6a94c23a68804253d89740a04a383a19d4beab2993242213e7a863a08c5b31e57d9fc1e19c487c9392e23f78cf277c21666e4a342a1441b8588406847aa75274629cb458b2d199d7a0d83a0e311d5ea837a786dca14e00cca1f139113d878d91407983a970ed7d1bacf797192790870599b2c00ad74d387e8a3124364d3e0abce3adde217840cec773a7b6aa24e608f9aac060a6882a1c0be66de0393ab9f35970a123f66d92118fbe414f297e75ef40c0fb5c8a81f3ffed9c8656f9a1eb36dbfda6e4e149c7f613f2d9808ca5c489c62342a0efb51345a3e887be428ae5de5a916e6c5c44490af183f86664cfcf799e283951cac83de8222c4cb5551b31027e5d1cf30957f40a54d3b677c8a39d135ea955053d3a85f299c74bb7fd259b6aafe229dc7cdeecd3b64dfdd090025f39af50061130b005d262d6c3abd128ca6ca4b38824218023de62c139d77835511a55f9b585f3db36f242ae1a8bd6798e852e4621e2f5d899083de2fc70d2cda7d40ebbaa43c0257c1df467f94732fff65193b08eca9d748ef09970bf458bd794f3bf62ec158df76d277c1781d032926ec6d5bd24f58bc3238da8fd10381dc0bca1364bd67baf6bb7836c018c1fd24e51f3c806b681f292ca28df431fa2088a98b7c0e6bb871bfc8b04f0d281a16bd8c3eb139368cee131768aca0394d86d8d7cecd85cea06f9bda7c87dd9f93c633f0dd34ee3d224051f1d41651fc2a205b9a7216d6a5fe24eb6b2d85cf63a67f73ff2eae26c4515d8ed3d2bbb33f85cecd86f1578697f35a321cf4fbcd546682c205fd734d166b34db146b585700bd7b10a48a807d7f5cc0c49f3e2c315c146ce607ae2e83ddac4cc0e7dd3aee1c4c6e8dc1d8fb7b323c1a24184d2ee01b5cbcf00e764c8f50da7e33335fdbf153382567cf32a2224ef2c62119da1ddb57218f5931aac2d4287f970a710428485bfac50ed91fec4abe482b807ba53bcc3817f025f74f19ed691948e24bb562b1248e014ee2a0296c6a82d73cb2cbb9f87dd2ea1dc8b1e6a9c7eceda859111309ae262357a1c2a5fdcab98117b99bc46158d61a14389bdfc69a23864b51da80a8dcbf5e4c90116634852dc8934cee044e6522b371f672d4043031a9285557131890172187e28f867d631c753d4879b60aa5f6b7c349068b50b83b288fa71d966611e2b87abef7508a7a1ce98bf3b318c2f9453a5e7285cba4daf75355ae409e3da1dd578f848d5a9990e361ea1ebc066aeea4dde1d28b43f3c321e80857c5760543a18c51d0c26f7333ab18f3b5dae553a2f9583e07eba70c5668b8e4b0a591a00000000');
  const prevoutTxOut = prevoutTx.outs[prevoutIndex];
  const { ecc: ecclib } = await secp256k1();
  const leaves: bip341.TaprootLeaf[] = [
    {
      scriptHex,
    }
  ];
  const hashTree = bip341.toHashTree(leaves);
  const output = BIP341Factory(ecclib).taprootOutputScript(
    internalPubkey,
    hashTree,
  );
  const taprootAddress = address.fromOutputScript(output, networks.testnet); // UNCONFIDENTIAL
  console.log(taprootAddress);


  /// let's try to spend it
  const inputs = [
    new CreatorInput(prevoutTxID, prevoutIndex),
  ];

  const outputs = [
    new CreatorOutput(
      networks.testnet.assetHash,
      50000,
      Buffer.of(OPS.OP_RETURN),
    ),
    new CreatorOutput(networks.testnet.assetHash, 100000 - 50000),
  ];

  const pset = Creator.newPset({
    inputs,
    outputs,
  });

  const updater = new Updater(pset);
  updater.addInWitnessUtxo(0, prevoutTxOut);
  /* updater.addInUtxoRangeProof(
    0,
    prevoutConfTx.outs[confUtxo.vout].rangeProof!,
  ); */
  updater.addInSighashType(0, Transaction.SIGHASH_ALL);

  const leafHash = bip341.tapLeafHash(leaves[0]);
  const pathToLeaf = bip341.findScriptPath(hashTree, leafHash);
  const [script, controlBlock] = BIP341Factory(ecclib).taprootSignScriptStack(
    internalPubkey,
    leaves[0],
    hashTree.hash,
    pathToLeaf,
  );

  updater.addInTapLeafScript(0, {
    controlBlock,
    leafVersion: bip341.LEAF_VERSION_TAPSCRIPT,
    script,
  });

  const finalizer = new Finalizer(pset);

  finalizer.finalizeInput(0, (index, pset: Pset) => {
    const tapLeafScript = pset.inputs[index]
      .tapLeafScript![0] as TapLeafScript;
    return {
      finalScriptSig: undefined,
      finalScriptWitness: witnessStackToScriptWitness([
        // Merkle inclusion proof

        Buffer.from('192ba599bc8f5e5b35b3ff04d1bda57dac2d726e6fd15181ade9105784097dfc', 'hex'),
        Buffer.from('348b8269fda663fe19ce47ccbb26a9d512ab759ad103b64655a146b9832216ea', 'hex'),
        Buffer.from('e0596898ccd511c7b7986951a601734ea5fd15474fa23fe70c5a3c93af8f5520', 'hex'),
        Buffer.from('ce1d84ab102ad318097de2d4e66848fef3c7a68b787f727d763460a4a01d854c', 'hex'),
        Buffer.from('e8fa1978a1075f52bb4de461f5df5cff9e8f7da8c2d51f95ce5a6362e5683d7a', 'hex'),
        Buffer.from('77b6caa0ca9f146a30c2170509c1a7a489bf67d20713752d62dafbd09b5440c8', 'hex'),
        Buffer.from('69b1fb99f443e066169af26f965121eddff39d721a469928c39838713868fa6e', 'hex'),
        Buffer.from('136b9de4d311458be68ef8840718874617f01a6cfc6c405577d6f2d1fa58a55a', 'hex'),
        Buffer.from('08a2c6c19859a5a2b4a75359207823aeae2763a8bd03049a11965945376ce10e', 'hex'),
        Buffer.from('51c3a10768ff893ae71b5bc97fdc7cd8d4a5420db390e92f1f6eb30a8a5e7088', 'hex'),
        Buffer.from('385af78b2646a7a184613bec4a770f4d081c7fb4961af5bbcd3dbbc1b5f29274', 'hex'),
        Buffer.from('b7da7cdd9daa6334983d473454cc1104cc18a20d1ef7e42cba42d972170473b5', 'hex'),
        Buffer.from('6e3862fcd79bf67a9d64710e6bd27815e79106cb5933f6435af1644c6a91b153', 'hex'),
        Buffer.from('3be8ab029e9d9a24adda121967593a4f926fcb5d75382feee53a59eb9e14b29a', 'hex'),
        // Encrypted chunk: 
        Buffer.from('d9a2c7ad0ec6d5e47a95465466b8e223720ea9365c0a8745f184a357feed626c', 'hex'),

        // Index 
        Buffer.from('0a', 'hex'),
        // Signature 
        Buffer.from('de6e8a2a1c8a698a16cd84eb0442acd3bc408ba355cc41308996f4b4fb0ca124b6e86bb2456b8697b39a6540ab634bb5151e6340eeacda97a658d247756f347c', 'hex'),


        // Preimage 
        Buffer.from('12d1e0adcc952d39c32399874c5c18f895212e47c63d36a052dcb95fc6aa1169', 'hex'),
        
        tapLeafScript.script,
        tapLeafScript.controlBlock,
      ]),
    };
  });

  const tx = Extractor.extract(pset);
  const hex = tx.toHex();
  console.log(hex);
})();


